You are working on the IWRITE project.

IMPORTANT CONTEXT (CURRENT STATE)

- The app is now booting correctly after you removed the duplicate QueryClientProvider wrapper in App.tsx.
- QueryClientProvider is correctly applied at the top level (in main.tsx). DO NOT change this again.
- Authentication, FREE/PAID plans, daily usage limits, seeding, Settings page, and basic upgrade UI are all implemented.
- There is already a billing-related file (e.g. `server/billingRoutes.ts` or similar) with partial logic.
- When clicking ‚ÄúUpgrade to PRO Now‚Äù in Settings, the UI shows ‚ÄúUpgrade Failed ‚Äì Stripe not configured‚Äù, meaning the guard logic exists but the full flow is not complete.
- There is **no** complete Super Admin panel yet.

Your job now is to FINISH the remaining work in a careful, production-safe way.

üéØ HIGH-LEVEL GOALS

1) Finalize the **upgrade & plan flow** (FREE ‚Üí PRO) including:
   - Clean UI states (not configured, loading, success, error).
   - Backend endpoints for creating Stripe checkout sessions.
   - A safe fallback behavior when Stripe is not configured (no crashes).
2) Implement a **Super Admin panel** for managing users & plans.
3) Run a full **verification pass** (build, health check, manual flows) and summarize.

You MUST NOT break existing working features or rename existing env vars / plans / routes.

---

üß© PART 1 ‚Äî DO NOT TOUCH THE QUERY CLIENT SETUP

1) Keep the current React Query setup as-is:
   - QueryClient is created and wrapped around the app in `client/src/main.tsx`.
   - App.tsx MUST NOT re-wrap with another QueryClientProvider.
2) Do NOT modify this again unless there is a proven, new runtime error directly caused by it.

---

üß© PART 2 ‚Äî UPGRADE FLOW & STRIPE INTEGRATION (SAFE & CONFIG-GATED)

1) Reuse existing billing code

- Locate existing billing code, for example:
  - `server/billingRoutes.ts`
  - Any routes under `/api/billing` or similar.
- Reuse and extend this code; do NOT create a completely parallel implementation.

2) Stripe configuration & env vars

- Use Stripe official Node SDK if not already used.
- Env vars (do NOT hardcode real values):
  - `STRIPE_SECRET_KEY`
  - `STRIPE_PUBLIC_KEY` (only used on frontend if needed)
  - `STRIPE_PRICE_ID_MONTHLY` (for the 14.99/month plan)
  - `STRIPE_PRICE_ID_YEARLY` (optional)
  - `STRIPE_WEBHOOK_SECRET` (optional, if you implement webhooks)
- Implement a helper function, e.g. `isStripeConfigured()`:
  - Returns true only if mandatory Stripe vars are present.
  - This helper will be used both on backend and (if needed) on frontend.

3) Backend endpoints

Implement or complete the following endpoints (names may be adapted to existing style, but keep behavior):

- `POST /api/billing/create-checkout-session`
  - Authenticated (use existing auth middleware).
  - Input: `{ plan: "monthly" | "yearly" }`.
  - If `!isStripeConfigured()`:
    - Return HTTP 503 or 400 with a clear JSON code, e.g.:
      - `{ error: "STRIPE_NOT_CONFIGURED" }`.
  - Else:
    - Create Stripe Checkout Session:
      - mode: `subscription`
      - line_items: price = `STRIPE_PRICE_ID_MONTHLY` or YEARLY
      - success_url: `${FRONTEND_URL}/upgrade/success?session_id={CHECKOUT_SESSION_ID}`
      - cancel_url: `${FRONTEND_URL}/plans?canceled=true`
      - store the IWRITE user id in `client_reference_id` or `metadata.userId`
    - Return `{ url: session.url }`.

- Either:
  - A webhook endpoint `POST /api/billing/webhook` that:
    - Validates Stripe signature using `STRIPE_WEBHOOK_SECRET`.
    - On `checkout.session.completed`:
      - Extracts the user id from metadata or client_reference_id.
      - Calls a helper `upgradeUserToPlan(userId, planType)` to set the user plan (e.g. PRO_MONTHLY).
  - OR a simpler, polling-based approach:
    - A `GET /api/billing/confirm?session_id=...` endpoint used by the success page.
    - It calls Stripe API to fetch the session and, if paid, upgrades the user.
- Use whichever approach is most compatible with the existing code and Replit environment, but document clearly which one you implemented.

4) Plan upgrade helper

- Implement or reuse a function (server-side), e.g.:

  ```ts
  async function upgradeUserToPlan(userId: string, planType: PlanType) { ... }
